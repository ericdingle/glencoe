<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module is="court-app">
  <script>
  var states = {
    PLAYING: 'playing',
    PAUSED: 'paused',
    STOPPED: 'stopped'
  };

  class CourtApp extends Polymer.Element {
    static get is() { return 'court-app'; }
    static get properties() { return {
      difficulty: Number,
      intervalLength: Number,
      restLength: Number,
      repetitions: Number,
      time: {
        type: Number,
        value: 0,
        notify: true,
      },
      index: {
        type: Number,
        value: -1,
        notify: true
      },
      state: {
        type: String,
        value: states.STOPPED,
        notify: true,
      },
      active: {
        type: Boolean,
        value: false,
        notify: true,
      }
    }}

    play() {
      if (this.state == states.STOPPED)
        this._run(1);
      this.state = states.PLAYING;
    }
    pause() {
      this.state = states.PAUSED;
    }
    stop() {
      this.state = states.STOPPED;
    }

    _run(repetition) {
      if (repetition > this.repetitions)
        return;

      var restLength = repetition == 1 ? 5 : this.restLength;

      var p1 = Promise.resolve()
          .then(this._setValue('active', false))
          .then(this._countDown(restLength))
          .then(this._setValue('active', true));

      var p2 = p1.then(this._countDown(this.intervalLength))
      var p3 = p1.then(this._randomIndex(this.intervalLength))

      Promise.all([p2, p3])
          .then(this._run.bind(this, repetition + 1))
          .catch(function() {});
    }

    _setValue(key, value) {
      return () => { this[key] = value; };
    }

    _countDown(duration) {
      return () => {
        var p = Promise.resolve();
        for (var i = 0; i <= duration; ++i) {
          p = p.then(this._setValue('time', duration - i))
               .then(this._delay(1000));
        }
        return p;
      };
    }

    _randomIndex(duration) {
      return () => {
        var d = 1.4;
        var p = Promise.resolve();
        for (var i = 0; i < duration; i += 2 * d) {
          p = p.then(this._setValue('index', Math.floor(Math.random() * 6)))
               .then(this._delay(d * 1000))
               .then(this._setValue('index', -1))
               .then(this._delay(d * 1000));
        }
        return p;
      };
    }

    _delay(duration) {
      return () => new Promise((resolve, reject) => {
        setTimeout(resolve, duration);
      }).then(this._checkState());
    }

    _checkState() {
      return () => {
        if (this.state == states.PLAYING)
          return Promise.resolve();
        if (this.state == states.STOPPED)
          return Promise.reject();

        return new Promise((resolve, reject) => {
          this.addEventListener('state-changed', (e) => {
            if (e.detail.value == states.PLAYING)
              setTimeout(resolve, 500);
            else if (e.detail.value == states.STOPPED)
              reject();
          });
        });
      };
    }
  }
  customElements.define(CourtApp.is, CourtApp);
  </script>
</dom-module>
