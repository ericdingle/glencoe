<link rel="import" href="/bower_components/polymer/polymer.html">
<dom-module is="court-app">
  <script>
  var states = {
    PLAYING: 'playing',
    PAUSED: 'paused',
    STOPPED: 'stopped'
  };

  Polymer({
    is: 'court-app',
    properties: {
      difficulty: Number,
      intervalLength: Number,
      restLength: Number,
      repetitions: Number,
      time: {
        type: Number,
        value: 0,
        notify: true,
      },
      index: {
        type: Number,
        value: -1,
        notify: true
      },
      state: {
        type: String,
        value: states.STOPPED,
        notify: true,
      },
      active: {
        type: Boolean,
        value: false,
        notify: true,
      }
    },

    play: function() {
      this.state = states.PLAYING;
      this._run(1);
    },
    pause: function() {
      if (this.state == states.PLAYING)
        this.state = states.PAUSED;
      else if (this.state == states.PAUSED)
        this.state = states.PLAYING;
      else
        console.error('Invalid state: ' + this.state);
    },
    stop: function() {
      this.state = states.STOPPED;
    },

    _run: function(repetition) {
      if (repetition > this.repetitions)
        return;

      var restLength = repetition == 1 ? 5 : this.restLength;

      var p1 = Promise.resolve()
          .then(this._setValue('active', false))
          .then(this._countDown(restLength))
          .then(this._setValue('active', true));

      var p2 = p1.then(this._countDown(this.intervalLength))
      var p3 = p1.then(this._randomIndex(this.intervalLength))

      Promise.all([p2, p3]).then(this._run.bind(this, repetition + 1));
    },

    _setValue: function(key, value) {
      return function() { this[key] = value; }.bind(this);
    },

    _countDown: function(duration) {
      return function() {
        var p = Promise.resolve();
        for (var i = 0; i <= duration; ++i) {
          p = p.then(this._setValue('time', duration - i))
               .then(this._delay(1000));
        }
        return p;
      }.bind(this);
    },

    _randomIndex: function(duration) {
      return function() {
        var p = Promise.resolve();
        for (var i = 0; i < duration; ) {
          var d = 1.4;
          p = p.then(this._setValue('index', Math.floor(Math.random() * 6)))
               .then(this._delay(d * 1000))
               .then(this._setValue('index', -1))
               .then(this._delay(d * 1000));
          i += 2 * d;
        }
        return p;
      }.bind(this);
    },

    _delay: function(duration) {
      return function() {
        return new Promise(function(resolve, reject) {
          setTimeout(resolve, duration);
        }).then(this._checkState.bind(this));
      }.bind(this);
    },

    _checkState: function() {
      if (this.state == states.PLAYING)
        return Promise.resolve();
      if (this.state == states.STOPPED)
        return Promise.reject();

      return new Promise(function(resolve, reject) {
        this.addEventListener('state-changed', function(e) {
          if (e.detail.value == states.PLAYING)
            resolve();
        });
      }.bind(this));
    }
  });
  </script>
</dom-module>
