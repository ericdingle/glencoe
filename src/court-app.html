<link rel="import" href="/bower_components/polymer/polymer.html">
<dom-module is="court-app">
  <script>
  Polymer({
    is: 'court-app',
    properties: {
      difficulty: Number,
      intervalLength: Number,
      restLength: Number,
      repetitions: Number,
      time: {
        type: Number,
        value: 0,
        notify: true,
      },
      index: {
        type: Number,
        value: -1,
        notify: true
      },
      active: {
        type: Boolean,
        value: false,
        notify: true,
      }
    },

    play: function() {
      this._run(1);
    },
    pause: function() {
    },
    stop: function() {
    },

    _run: function(repetition) {
      if (repetition > this.repetitions) {
        return;
      }

      var restLength = repetition == 1 ? 5 : this.restLength;

      var p1 = Promise.resolve()
          .then(setValue('active', false).bind(this))
          .then(countDown(restLength).bind(this))
          .then(setValue('active', true).bind(this));

      var p2 = p1.then(countDown(this.intervalLength).bind(this))
      var p3 = p1.then(randomIndex(this.intervalLength).bind(this))

      Promise.all([p2, p3]).then(this._run.bind(this, repetition + 1));
    }
  });

  function setValue(key, value) {
    return function() {
      this[key] = value;
    };
  }

  function countDown(duration) {
    return function() {
      var p = Promise.resolve();
      for (var i = 0; i <= duration; ++i) {
        p = p.then(setValue('time', duration - i).bind(this))
             .then(delay(1000));
      }
      return p;
    };
  }

  function randomIndex(duration) {
    return function() {
      var p = Promise.resolve();
      for (var i = 0; i < duration; ) {
        var d = 1.4;
        p = p.then(setValue('index', Math.floor(Math.random() * 6)).bind(this))
             .then(delay(d * 1000))
             .then(setValue('index', -1).bind(this))
             .then(delay(d * 1000));
        i += 2 * d;
      }
      return p;
    }
  }

  function delay(duration) {
    return function() {
      return new Promise(function(resolve, reject) {
        setTimeout(resolve, duration);
      });
    };
  }
  </script>
</dom-module>
